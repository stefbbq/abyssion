# Codex

Reference for the codebase structure.
Use this as a starting point before doing anything!

## Core Architecture

- **Routing**: Fresh-based, with a partial-first approach for SPA-like navigation. Global UI is controlled by `_app.tsx` and `data/pages.json`.
- **Access Control**: Centralized in `routes/_middleware.ts` for `debugOnly` pages.
- **Data & Types**: All static content is in `/data`, with all corresponding TypeScript types co-located in `data/types.ts`.
- **Theme System**: A dual-theme system (`UITheme` and `GLTheme`) is generated from a single `BaseTheme`. See the "Theme System" section below for details.
- **3D Scene**: Managed via `/scene`, `/gl`, and related directories, containing all Three.js logic.

## Theme System

The system uses a `BaseTheme` (color palette + mode) to generate two distinct themes:

1. **UITheme**: For all UI components, generated by `createTheme()`. It ensures proper color contrast for the current mode (light/dark).
2. **GLTheme**: For 3D rendering, generated by `createGLTheme()`. It uses colors optimized for 3D visibility, regardless of the UI mode.

**Key Functions:**

- `getTheme()`: Returns the current `UITheme`.
- `getGLTheme()`: Returns the current `GLTheme`.
- `toggleThemeMode()`: Toggles between 'light' and 'dark' modes.
- `setThemeMode()`: Sets a specific mode.

## Directory Structure

- **`/routes`**: Pages & API
  - `_app.tsx`: Main app wrapper. Conditionally renders global UI based on `data/pages.json`.
  - `_middleware.ts`: Global middleware for server-side logic (e.g., `debugOnly` access).
  - `theme.tsx`: Renders the `ThemeVisualizer` island.
  - `/partials/*.tsx`: Page content for Fresh's partial navigation.

- **`/islands`**: Interactive Components
  - `ActionZoneController.tsx`: Interactive mobile navigation.
  - `ThemeVisualizer.tsx`: UI for visualizing themes.
  - `Header.tsx`, `GLCanvas.tsx`, `MusicPlayer.tsx`: Other major interactive components.

- **`/components`**: Reusable UI Components (Atomic Design)
  - `/atoms`: Basic building blocks (`Button`, `Icon`).
  - `/molecules`: Combinations of atoms (`CollapsedNav`, `NavButton`).
  - `/organisms`: Complex components (`ActionZone`, `Header`).

- **`/data`**: Content & Configuration
  - `types.ts`: **Centralized TypeScript definitions** for all JSON data.
  - `pages.json`: Site-wide page configuration (`debugOnly`, `showHeader`).
  - `*.json`: Static content for pages (navigation, shows, bio).

- **`/lib`**: Core Libraries
  - `/theme`: The core UI theme system. See "Theme System" section above.
  - `/gl/theme`: The 3D-specific theme system.
  - `/debug`: Debug mode detection and control.
  - `/logger`: Structured logging system.

- **`/utils`**: Shared utility functions.
- **`/scene`, `/gl`, etc.**: All logic for the Three.js visualization.

## Main Entry

- `index.ts` - `initGL()`, `InitOptions`, `RendererState`
- `types.ts` - Core GL types

## Theme System (New Architecture)

### Core Theme System (`lib/theme/`)

- `index.ts` - `getTheme()`, `toggleThemeMode()`, `setThemeMode()`
- `types.ts` - `BaseTheme`, `UITheme`, theme type definitions
- `themes/index.ts` - Theme exports barrel
- `utils/createBaseTheme.ts` - `createBaseTheme()`
- `utils/hexToCSS.ts` - `hexToCSS()`

### GL Theme System (`lib/gl/theme/`)

- `index.ts` - `getGLTheme()`, `createGLTheme()`
- `types.ts` - `GLTheme` type definitions

## Islands (Interactive Components)

This directory contains interactive client-side components (islands)

- `islands/ActionZoneController.tsx` - The main interactive mobile navigation system controller
- `islands/Header.tsx` - The main interactive desktop navigation header
- `islands/ThemeVisualizer.tsx` - The interactive UI for visualizing different application themes
- `islands/GLCanvas.tsx` - The interactive 3D logo component
- `islands/MusicPlayer.tsx` - The interactive audio player component
- `islands/ClientInitializer.tsx` - Initializes client-side systems (e.g., logger) and debug settings

## Component-Based Architecture (Atomic Design)

Component logic is organized using Atomic Design principles in `/components`

- **/components/atoms/**: Basic building blocks (`Button.tsx`, `Icon.tsx`)
- **/components/molecules/**: Combinations of atoms (`CollapsedNav.tsx`, `ExpandedMenu.tsx`)
- **/components/organisms/**: Complex components (`ActionZone.tsx`, `Header.tsx`, `MusicPlayer.tsx`)

## Data Content System

- `data/types.ts` - Centralized TypeScript definitions for all JSON data structures
- `data/pages.json` - Site-wide page configuration (`debugOnly`, `showHeader`, `showActionZone`)
- `data/nav.json` - Source of truth for all site navigation links
- `data/nav-actionZone-animation.json` - State machine for ActionZone button animations
- `data/content-shows.json` - Data for upcoming and past shows
- `data/content-bio-*.json` - Data for the biography page (members, albums, etc.)

## Routes (Pages)

- `routes/_middleware.ts` - Global middleware. Handles `debugOnly` page access control before rendering
- `routes/_app.tsx` - App wrapper. Conditionally renders global UI based on `data/pages.json` config
- `routes/theme.tsx` - Renders the `ThemeVisualizer` island. Access is controlled by middleware
- `routes/index.tsx`, `bio.tsx`, etc. - Top-level page routes that re-export their corresponding partials
- `routes/partials/` - Directory for partial page content, enabling SPA-like navigation

## Setup (Composable Utilities)

- `setup/index.ts` - Barrel exports
- `setup/setupCoreRendering.ts` - `setupCoreRendering()`
- `setup/setupResponsiveHandling.ts` - `setupResponsiveHandling()`
- `setup/setupTextureLoading.ts` - `setupTextureLoading()`
- `setup/setupLayerSystem.ts` - `setupLayerSystem()`
- `setup/setupDebugSystem.ts` - `setupDebugSystem()`

## Scene

- `scene/createScene.ts` - `createScene()`
- `scene/createCamera.ts` - `createCamera()`
- `scene/createRenderer.ts` - `createRenderer()`
- `scene/createPostProcessing.ts` - `createPostProcessing()`
- `scene/createLogoPlaneGeometry.ts` - `createLogoPlaneGeometry()`
- `scene/utils/getResponsiveCameraZ.ts` - `getResponsiveCameraZ()`

## Animation

- `animation/index.ts` - Main animation exports
- `animation/createLogoAnimator.ts` - `createLogoAnimator()`
- `animation/core/createAnimationEngine.ts` - `createAnimationEngine()`

## Layers

- `layers/index.ts` - Barrel exports
- `layers/LogoLayer.ts` - `createLogoLayer()`
- `layers/GeometricLayer.ts` - `createGeometricLayer()`
- `layers/ShadowLayer.ts` - `createShadowLayer()`

## Controls

- `controls/index.ts` - `createControlsSystem()`
- `controls/createControlsSystem.ts` - Main controls orchestrator
- `controls/OrbitControlsSetup.ts` - `setupOrbitControls()`

## Textures & Shaders

- `textures/VideoCycle/index.ts` - `createVideoCycle()`
- `shaders/index.ts` - Barrel exports for GLSL shaders

## Debug & Logger Systems

- `lib/debug/index.ts` - Debug mode detection and control
- `lib/logger/index.ts` - Structured, color-coded logging system

## Utils (Utility Functions)

- `utils/index.ts` - Main utils barrel exports. **Note:** Navigation types are now in `data/types.ts`

## Documentation

- `THEME_SYSTEM.md` - Complete theme system architecture guide
- `CODEX.md` - This file
- `LLM_GUIDE.md` - LLM code styles and guidelines.

## Core Architecture Summary

- **Routing**: Fresh-based, with a partial-first approach. UI and access control are configured in `data/pages.json` and enforced by `_app.tsx` and `_middleware.ts`
- **Data & Types**: All static content is in `/data`, with all corresponding TypeScript types co-located in `data/types.ts`
- **State Management**: Primarily Preact Signals for UI state
- **3D Scene**: Managed via `/scene`, `/gl`, and related directories, containing all Three.js logic
